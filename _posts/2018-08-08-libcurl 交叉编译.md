---
layout: post
title: libcurl 交叉编译
date: 2018-08-08
tags: [HTTPS]
---

基于curl + openssl + zlib 的方式组建arm上的https客户端，其中curl作为http客户端，openssl提供https支持，zlib负责处理gzip压缩的http报文(可选)。


## 编译zlib ##

```shell
wget https://zlib.net/zlib-1.2.11.tar.gz

tar -xzvf zlib-1.2.11.tar.gz

cd zlib-1.2.11/

CC=arm-hisiv500-linux-gcc AR=arm-hisiv500-linux-ar RANLIB=arm-hisiv500-linux-ranlib ./configure --prefix=$HOME/tools/zlib 
#configure不支持指定交叉工具链, 因此需提前设定CC, AR, RANLIB变量

make && make install
```

## 编译openssl ##

```shell
wget https://github.com/openssl/openssl/archive/OpenSSL_1_1_0h.tar.gz

tar -xzvf OpenSSL_1_1_0h.tar.gz

cd openssl-OpenSSL_1_1_0h

./Configure linux-armv4  --prefix=$HOME/tools/libopenssl  no-async

export CROSS_COMPILE=arm-hisiv500-linux-   

make CC=${CROSS_COMPILE}gcc  RANLIB=${CROSS_COMPILE}ranlib  && make install
```

debug:

```
perl configdata.pm --dump
```

以及

```shell
# ./openssl version -a
```

问题：

1. Configuring for os/compiler:arm-hisiv500-linux-
Warning! target os/compiler:arm-hisiv500-linux- doesn't exist!

平台不能自定义，老版本才可以。

2. ./libcrypto.so: undefined reference to `getcontext'
./libcrypto.so: undefined reference to `setcontext'
./libcrypto.so: undefined reference to `makecontext'

执行`Configure` 脚本添加选项no-async。

## 编译libcurl ##

```shell
wget https://curl.haxx.se/download/curl-7.61.0.tar.gz

tar -xzvf curl-7.61.0.tar.gz

cd curl-7.61.0

CROSS_COMPILE=arm-hisiv500-linux- CC=${CROSS_COMPILE}gcc AR=${CROSS_COMPILE}ar RANLIB=${CROSS_COMPILE}ranlib AS=${CROSS_COMPILE}as LD=${CROSS_COMPILE}ld nm=${CROSS_COMPILE}nm ./configure --host=arm-hisiv500-linux --target=arm-hisiv500-linux --build=x86_64-linux-gnu --prefix=$HOME/tools/libcurl --with-zlib=$HOME/tools/zlib --with-ssl=$HOME/tools/libopenssl --with-ca-path=/etc/ssl/certs --enable-http  --enable-ipv6 --disable-rtsp  --disable-pop3 --disable-imap --disable-gopher --disable-smb --without-librtmp --disable-tftp --disable-ftp --disable-smtp --disable-dict --disable-file --without-nghttp2 --disable-ldap --disable-ldaps

make && make install
```

libcurl 裁剪后，配置信息如下：

```shell
curl version:     7.61.0
Host setup:       arm-hisiv500-linux-gnu
Install prefix:   /home/kgbook/tools/libcurl
Compiler:         arm-hisiv500-linux-gcc
SSL support:      enabled (OpenSSL)
SSH support:      no      (--with-libssh2)
zlib support:     enabled
brotli support:   no      (--with-brotli)
GSS-API support:  no      (--with-gssapi)
TLS-SRP support:  enabled
resolver:         POSIX threaded
IPv6 support:     enabled
Unix sockets support: enabled
IDN support:      no      (--with-{libidn2,winidn})
Build libcurl:    Shared=yes, Static=yes
Built-in manual:  enabled
--libcurl option: enabled (--disable-libcurl-option)
Verbose errors:   enabled (--disable-verbose)
SSPI support:     no      (--enable-sspi)
ca cert bundle:   no
ca cert path:     /etc/ssl/certs
ca fallback:      no
LDAP support:     no      (--enable-ldap / --with-ldap-lib / --with-lber-lib)
LDAPS support:    no      (--enable-ldaps)
RTSP support:     no      (--enable-rtsp)
RTMP support:     no      (--with-librtmp)
metalink support: no      (--with-libmetalink)
PSL support:      no      (libpsl not found)
HTTP2 support:    disabled (--with-nghttp2)
Protocols:        HTTP HTTPS TELNET
```

注意：

1. SSL certificate problem
libcurl使用HTTPS会遇到运行时错误，也就是证书问题，编译libcurl需要配置`--with-ca-path`参数。

log：
```shell
*   Trying 183.60.177.251...
* TCP_NODELAY set
* Connected to api.bi.tuputech.com (183.60.177.251) port 443 (#0)
* Cipher selection: ALL:!EXPORT:!EXPORT40:!EXPORT56:!aNULL:!LOW:!RC4:@STRENGTH
* NPN, negotiated HTTP1.1
* SSL certificate problem: unable to get local issuer certificate
* Closing connection 0
start:58, SSL certificate problem: unable to get local issuer certificate
```  

2. configure error: a bad --with-ssl prefix
编译openssl时候配置prefix path为$HOME/tools/libopenss, 而配置libcurl时候--with-ssl=$HOME/tools/libopenssl，路径不一致。

## 参考文献 ##

- [failed to cross compile libcurl, unknown type name ‘DES_key_schedule’](https://github.com/openssl/openssl/issues/6657)
- [how to caculate the version number of openssl](https://github.com/openssl/openssl/issues/6657)
- [openssl download](https://www.openssl.org/source/openssl-1.0.1u.tar.gz)
- [libcurl download](https://curl.haxx.se/download/curl-7.61.0.tar.gz)
- [after ./config，CC error ](https://github.com/openssl/openssl/issues/1607)
- [configure error: a bad --with-ssl prefix](https://github.com/curl/curl/issues/2826)